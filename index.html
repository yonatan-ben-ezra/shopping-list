<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4a90e2">
    
    <title>专砖转 拽转 砖</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4a90e2; 
            --accent: #50e3c2;
            --dark: #2C3A47;
            --bg: #f0f2f5;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --danger: #ff6b6b;
            --success: #2ecc71;
            --success-bg: #d4edda;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Rubik', sans-serif;
            background: var(--bg);
            color: var(--dark);
            margin: 0; padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            overscroll-behavior-y: none;
        }

        /* --- 住 转 --- */
        #homeView {
            padding: 20px;
            padding-top: 40px;
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .home-header { text-align: center; margin-bottom: 20px; }
        .home-header h1 { margin: 0; color: var(--primary); font-size: 2rem; }
        .home-header p { margin: 5px 0 0; color: #888; }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 50px;
        }

        .cat-card {
            background: white;
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1/1;
        }

        .cat-card:active { transform: scale(0.95); }
        .cat-card i { font-size: 2.2rem; margin-bottom: 10px; color: var(--primary); }
        .cat-card h3 { margin: 0; font-size: 1rem; font-weight: 600; }
        
        .cat-card.all-cats {
            background: linear-gradient(135deg, var(--primary), #357abd);
            color: white;
            grid-column: span 2;
            aspect-ratio: auto;
            padding: 25px;
            flex-direction: row;
            gap: 15px;
        }
        .cat-card.all-cats i { color: white; margin: 0; font-size: 1.8rem; }
        .cat-card.all-cats h3 { font-size: 1.3rem; }

        .cat-card.tasks-card { border-bottom: 4px solid var(--accent); }
        .cat-card.my-card { border-bottom: 4px solid var(--primary); background: #fdfdfd; }

        /* --- 住 驻 --- */
        #categoryView {
            display: none;
            flex-direction: column;
            height: 100%;
            background: #fff;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 50;
        }

        .sticky-section {
            background: var(--glass);
            padding: 10px 15px 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            z-index: 10;
            border-bottom: 1px solid #eee;
            position: relative;
            padding-top: env(safe-area-inset-top);
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            margin-top: 10px;
        }

        .back-btn { background: #eee; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .view-title { font-size: 1.2rem; font-weight: 800; color: var(--primary); }

        /* --- 驻住 转拽转 (砖) --- */
        #progressContainer {
            margin-bottom: 10px;
            display: none; /* 住转专 专专转  注 砖砖 驻专 */
        }
        
        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .progress-track {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            width: 100%;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s;
            border-radius: 4px;
        }
        
        .progress-fill.completed {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        /* --- 驻住 --- */
        #formContainer {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 300px;
            opacity: 1;
            overflow: visible;
        }
        
        #formContainer.collapsed {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            margin: 0;
        }

        .collapse-btn {
            width: 100%;
            text-align: center;
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            padding: 5px 0;
            font-size: 0.9rem;
        }
        .collapse-btn:hover { color: var(--primary); }

        .add-form { display: flex; flex-direction: column; gap: 10px; position: relative; padding-bottom: 5px; }
        
        .input-row { display: flex; gap: 10px; align-items: center; }
        
        select, input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            background: #f9f9f9;
        }
        
        select { width: 100%; }
        
        #itemQty { 
            width: 50px; text-align: center; background: #fff; cursor: pointer; font-weight: bold; color: var(--primary);
        }

        #itemName { flex-grow: 1; }
        
        .note-btn {
            background: #f0f2f5; border: 1px solid #ddd; width: 45px; height: 45px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: #888;
        }
        .note-btn.active { background: #e3f2fd; color: var(--primary); border-color: var(--primary); }
        
        .add-btn {
            background: var(--accent); color: var(--dark); border: none; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(80, 227, 194, 0.3);
        }

        #qtyToolbar {
            position: absolute; top: 50px; right: 0; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-radius: 10px; padding: 8px; display: none; white-space: nowrap; overflow-x: auto; max-width: 280px; z-index: 20;
        }
        .qty-option {
            display: inline-block; width: 35px; height: 35px; line-height: 35px; text-align: center; background: #f0f2f5;
            margin: 2px; border-radius: 50%; cursor: pointer; font-weight: bold;
        }
        .qty-option:hover { background: var(--primary); color: white; }

        #listScrollArea { flex-grow: 1; overflow-y: auto; padding: 15px; background: #fcfcfc; padding-bottom: 80px; }

        .sub-group-title {
            font-size: 0.95rem; 
            color: #555; 
            margin: 20px 0 10px; 
            padding: 10px;
            background: #eee;
            border-radius: 8px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }
        
        .sub-group-title:hover { background: #e0e0e0; }
        .sub-group-title i { transition: transform 0.3s; color: var(--primary); }
        .sub-group-title.closed i { transform: rotate(180deg); }
        
        .sub-group-title.completed {
            background-color: var(--success-bg);
            color: #155724;
            border-right: 5px solid var(--success);
        }
        .sub-group-title.completed i { color: var(--success); }

        .product-item {
            background: white; border-radius: 12px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: all 0.3s ease;
        }

        .product-item.is-purchased {
            opacity: 0.7;
            background-color: #f6fff8;
            box-shadow: none;
        }
        .product-item.is-purchased .item-name {
            text-decoration: line-through;
            color: #888;
        }

        .qty-circle {
            width: 35px; height: 35px; background: var(--primary); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; 
            margin-left: 10px; flex-shrink: 0; font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .qty-circle.purchased {
            background-color: var(--success);
            transform: scale(1.1);
        }

        .qty-circle.clickable:active { transform: scale(0.9); }

        .item-content { flex-grow: 1; cursor: pointer; }
        .item-name { font-weight: 600; font-size: 1.1rem; transition: color 0.3s; }
        .item-note { font-size: 0.85rem; color: #666; background: #f0f0f0; padding: 5px 10px; border-radius: 6px; margin-top: 5px; display: none; }
        
        .global-badge { color: gold; font-size: 0.8rem; margin-right: 5px; }
        .note-indicator { color: #888; font-size: 0.9rem; margin-right: 5px; }

        .delete-btn {
            background: #ffecec; color: var(--danger); border: none; width: 30px; height: 30px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; margin-right: 10px; cursor: pointer;
        }

        .admin-float {
            position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.8); padding: 5px 10px;
            border-radius: 20px; font-size: 0.8rem; border: none; backdrop-filter: blur(5px); z-index: 5;
        }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; max-height: 80vh; overflow-y: auto; }
        .close-modal { float: right; font-size: 1.5rem; cursor: pointer; }

        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; justify-content: center; }
        .tag-chip { background: #f0f2f5; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .tag-chip i { color: var(--danger); cursor: pointer; }
        .editor-section { border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px; }
    </style>
</head>
<body>

<div id="homeView">
    <button class="admin-float" onclick="openAdminLogin()"><i class="fas fa-user-shield"></i> </button>
    <div class="home-header">
        <h1>拽转 砖</h1>
        <p>专 拽专</p>
    </div>
    <div class="grid-container" id="categoryGrid"></div>
</div>

<div id="categoryView">
    <div class="sticky-section">
        <div class="view-header">
            <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-right"></i> 专</button>
            <div class="view-title" id="viewTitle">砖 拽专</div>
            <div style="width: 60px;"></div>
        </div>

        <div id="progressContainer">
            <div class="progress-labels">
                <span id="progText">0/0 拽</span>
                <span id="progPercent">0%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progFill"></div>
            </div>
        </div>

        <div id="formContainer">
            <div class="add-form" id="addForm">
                <select id="subCatSelect"></select>
                
                <div class="input-row">
                    <input type="text" id="itemQty" value="1" readonly onclick="toggleQtyBar()">
                    <input type="text" id="itemName" placeholder=" 拽转?">
                    <button class="note-btn" id="noteBtn" onclick="editNote()"><i class="fas fa-edit"></i></button>
                </div>

                <div id="qtyToolbar"></div>
                
                <button class="add-btn" onclick="addItem()">住祝 专砖 <i class="fas fa-plus"></i></button>
            </div>
            <div id="lockedMsg" style="display:none; color:red; text-align:center; margin-top:5px;">专砖 注</div>
        </div>
        
        <button class="collapse-btn" id="collapseBtn" onclick="toggleFormVisibility()">
            <i class="fas fa-chevron-up"></i>
        </button>
    </div>

    <div id="listScrollArea"></div>
</div>

<div id="passwordModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('passwordModal')">&times;</span>
        <h3>住转 </h3>
        <input type="password" id="adminPass" placeholder="住住" style="width:100%; margin:15px 0;">
        <button class="add-btn" onclick="checkPass()">住</button>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('settingsModal')">&times;</span>
        <h3><i class="fas fa-cog"></i>  拽专转</h3>
        <div class="editor-section">
            <label>专 拽专 注专:</label>
            <select id="editorCatSelect" onchange="renderEditorSubs()"></select>
        </div>
        <div class="editor-section" id="subsEditorArea" style="display:none;">
            <h4>转转 拽专转 拽转:</h4>
            <div class="tags-container" id="editorTags"></div>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <input type="text" id="newSubInput" placeholder="转转 拽专 砖...">
                <button onclick="addNewSub()" style="background:var(--primary); color:white; border:none; border-radius:8px; width:40px;"><i class="fas fa-plus"></i></button>
            </div>
        </div>
        <div class="editor-section">
            <button class="add-btn" onclick="toggleLock()" style="background:#ff6b6b; width:100%;">注/驻转 住驻转 爪专</button>
            <button class="add-btn" onclick="hardResetCategories()" style="background:orange; width:100%; margin-top:10px; font-size:0.9rem;">
                <i class="fas fa-wrench"></i> 驻住 拽专转  转拽
            </button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAoXUKwnQpcxyZdYCT9PUh-yjmOj6kugTQ",
        authDomain: "family-shopping-891f7.firebaseapp.com",
        databaseURL: "https://family-shopping-891f7-default-rtdb.firebaseio.com",
        projectId: "family-shopping-891f7",
        storageBucket: "family-shopping-891f7.firebasestorage.app",
        messagingSenderId: "16936955736",
        appId: "1:16936955736:web:dca42916750112b7787f2d",
        measurementId: "G-QPL3C428RN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let userId = localStorage.getItem('shop_uid');
    if(!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 5);
        localStorage.setItem('shop_uid', userId);
    }

    let isAdmin = false;
    let currentViewKey = null;
    let allData = {};
    let appSettings = {};
    let currentNote = "";
    let isFormVisible = true;
    let collapsedState = {}; 

    const defaultCats = {
        osher_ad: { 
            label: "砖专 注", icon: "fa-cart-shopping", 
            subs: ["驻专转 专拽转", "拽驻", "住", "爪专 ", "爪专", " 驻注", "拽", "专"] 
        },
        tambour: { 
            label: "专", icon: "fa-screwdriver-wrench", 
            subs: ["砖", " 注", "驻专", "专 ", "专"] 
        },
        max_stock: { 
            label: "拽住 住拽", icon: "fa-box-open", 
            subs: ["专"] 
        },
        other: { 
            label: "专", icon: "fa-star", 
            subs: [""] 
        },
        tasks: {
            label: "砖转", icon: "fa-list-check",
            subs: ["爪注", "祝"]
        }
    };

    const settingsRef = ref(db, 'settings');
    onValue(settingsRef, (snap) => {
        const val = snap.val();
        if (!val) {
            set(settingsRef, { categories: defaultCats, locked: false, pass: "1234" });
            return;
        }
        
        const currentKeys = Object.keys(val.categories || {});
        const requiredKeys = ['osher_ad', 'tambour', 'max_stock', 'other', 'tasks'];
        const missingKeys = requiredKeys.filter(k => !currentKeys.includes(k));
        if (missingKeys.length > 0) {
            update(ref(db, 'settings/categories'), defaultCats);
            return;
        }

        appSettings = val;
        renderHome();
        if (currentViewKey) renderList();
    });

    onValue(ref(db, 'shoppingList'), (snap) => {
        allData = snap.val() || {};
        if (currentViewKey) renderList();
    });

    function renderHome() {
        const grid = document.getElementById('categoryGrid');
        grid.innerHTML = "";

        const allBtn = document.createElement('div');
        allBtn.className = 'cat-card all-cats';
        allBtn.innerHTML = `<i class="fas fa-layer-group"></i><h3> 拽专转</h3>`;
        allBtn.onclick = () => openCategory('all_view');
        grid.appendChild(allBtn);

        const cats = appSettings.categories || defaultCats;

        const createCard = (key, data, customClass = '') => {
            const card = document.createElement('div');
            card.className = `cat-card ${customClass}`;
            card.innerHTML = `<i class="fas ${data.icon || 'fa-circle'}"></i><h3>${data.label}</h3>`;
            card.onclick = () => openCategory(key);
            grid.appendChild(card);
        };

        if(cats.osher_ad) createCard('osher_ad', cats.osher_ad);
        if(cats.tambour) createCard('tambour', cats.tambour);
        if(cats.max_stock) createCard('max_stock', cats.max_stock);
        if(cats.other) createCard('other', cats.other);
        if(cats.tasks) createCard('tasks', cats.tasks, 'tasks-card');

        const myCard = document.createElement('div');
        myCard.className = 'cat-card my-card';
        myCard.innerHTML = `<i class="fas fa-user-tag"></i><h3>爪专 砖住驻转</h3>`;
        myCard.onclick = () => openCategory('my_added');
        grid.appendChild(myCard);

        if(isAdmin) {
            const editBtn = document.createElement('div');
            editBtn.className = 'cat-card';
            editBtn.style.background = '#eee';
            editBtn.innerHTML = '<i class="fas fa-cog"></i><h3>专转</h3>';
            editBtn.onclick = openSettingsUI;
            grid.appendChild(editBtn);
        }
    }

    window.onpopstate = function(event) {
        if (currentViewKey) {
            closeCategoryView();
        }
    };

    window.goBack = function() {
        window.history.back();
    }

    function closeCategoryView() {
        currentViewKey = null;
        document.getElementById('categoryView').style.display = 'none';
        document.getElementById('homeView').style.display = 'flex';
    }

    window.openCategory = function(key) {
        window.history.pushState({ view: 'category' }, '');

        currentViewKey = key;
        document.getElementById('homeView').style.display = 'none';
        document.getElementById('categoryView').style.display = 'flex';
        
        const subSelect = document.getElementById('subCatSelect');
        subSelect.innerHTML = "";
        const formContainer = document.getElementById('formContainer');
        const collapseBtn = document.getElementById('collapseBtn');
        const nameInput = document.getElementById('itemName');
        const progContainer = document.getElementById('progressContainer');

        isFormVisible = true;
        formContainer.classList.remove('collapsed');
        collapseBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
        document.getElementById('itemQty').value = "1";
        document.getElementById('qtyToolbar').style.display = 'none';
        currentNote = "";
        updateNoteBtnState();

        // 爪转 驻住 转拽转 (驻住 转)
        progContainer.style.display = 'block';

        if (key === 'tasks') {
            nameInput.placeholder = " 砖?";
        } else {
            nameInput.placeholder = " 拽转?";
        }

        if (key === 'all_view') {
            document.getElementById('viewTitle').innerText = " 拽专转";
            const opt = document.createElement('option');
            opt.value = "global";
            opt.innerText = " (驻注  专砖转)";
            subSelect.appendChild(opt);
            formContainer.style.display = "block";
            collapseBtn.style.display = "block";
        } else if (key === 'my_added') {
            document.getElementById('viewTitle').innerText = "爪专 砖住驻转";
            formContainer.style.display = "none"; 
            collapseBtn.style.display = "none";
            progContainer.style.display = 'none'; //  驻住 转拽转 
        } else {
            const catData = (appSettings.categories || defaultCats)[key];
            if(catData) {
                document.getElementById('viewTitle').innerText = catData.label;
                formContainer.style.display = "block";
                collapseBtn.style.display = "block";
                if (catData.subs) {
                    catData.subs.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub;
                        opt.innerText = sub;
                        subSelect.appendChild(opt);
                    });
                }
            }
        }
        
        const locked = appSettings.locked && !isAdmin;
        if (key !== 'my_added') {
            document.getElementById('addForm').style.display = locked ? 'none' : 'flex';
            document.getElementById('lockedMsg').style.display = locked ? 'block' : 'none';
            if(locked) collapseBtn.style.display = 'none';
        } else {
            document.getElementById('lockedMsg').style.display = 'none';
        }

        renderList();
    }

    window.toggleFormVisibility = function() {
        const container = document.getElementById('formContainer');
        const btn = document.getElementById('collapseBtn');
        isFormVisible = !isFormVisible;
        if (isFormVisible) {
            container.classList.remove('collapsed');
            btn.innerHTML = '<i class="fas fa-chevron-up"></i>';
        } else {
            container.classList.add('collapsed');
            btn.innerHTML = '<i class="fas fa-chevron-down"></i>';
        }
    }

    window.toggleGroup = function(groupName) {
        collapsedState[groupName] = !collapsedState[groupName];
        renderList();
    }

    window.togglePurchased = function(id, currentStatus) {
        if (!isAdmin) return;
        const newStatus = !currentStatus;
        update(ref(db, `shoppingList/${id}`), { purchased: newStatus });
    }

    function renderList() {
        const container = document.getElementById('listScrollArea');
        container.innerHTML = "";
        
        const items = Object.entries(allData).map(([id, val]) => ({ id, ...val }));
        const cats = appSettings.categories || defaultCats;
        let filteredItems = [];

        if (currentViewKey === 'all_view') {
            filteredItems = items.filter(i => i.mainCat !== 'tasks');
        } else if (currentViewKey === 'my_added') {
            filteredItems = items.filter(i => i.owner === userId && i.mainCat !== 'tasks');
        } else if (currentViewKey === 'tasks') {
            filteredItems = items.filter(i => i.mainCat === 'tasks');
        } else {
            filteredItems = items.filter(i => 
                (i.mainCat === currentViewKey || i.mainCat === 'global') && i.mainCat !== 'tasks'
            );
        }

        // --- 注 驻住 转拽转 ---
        const totalItems = filteredItems.length;
        const boughtItems = filteredItems.filter(i => i.purchased).length;
        const progContainer = document.getElementById('progressContainer');
        const progFill = document.getElementById('progFill');
        const progText = document.getElementById('progText');
        const progPercent = document.getElementById('progPercent');

        if (totalItems > 0 && currentViewKey !== 'my_added') {
            progContainer.style.display = 'block';
            const pct = Math.round((boughtItems / totalItems) * 100);
            progFill.style.width = pct + '%';
            
            // 注 拽住
            progText.innerText = `${boughtItems}/${totalItems} 拽`;
            progPercent.innerText = pct + '%';
            
            // 砖 爪注 住
            if (pct === 100) {
                progFill.classList.add('completed');
                progText.innerText = "砖! ";
            } else {
                progFill.classList.remove('completed');
            }
        } else {
            progContainer.style.display = 'none';
        }

        if (filteredItems.length === 0) {
            container.innerHTML = '<div style="text-align:center; margin-top:30px; color:#aaa;">拽专 专拽</div>';
            return;
        }

        const grouped = {};
        
        filteredItems.forEach(item => {
            let groupKey = "";
            let prefix = ""; 
            let title = "";

            if (currentViewKey === 'all_view') {
                if (item.mainCat === 'global') {
                    prefix = "0_";
                    title = "驻专 ";
                } else {
                    prefix = "1_";
                    title = cats[item.mainCat] ? cats[item.mainCat].label : "专";
                }
            } else if (currentViewKey === 'my_added') {
                if (item.mainCat === 'global') {
                    prefix = "1_"; title = "";
                } else {
                    prefix = "1_";
                    title = cats[item.mainCat] ? cats[item.mainCat].label : "专";
                }
            } else if (currentViewKey === 'tasks') {
                prefix = "1_"; title = item.subCat;
            } else {
                if (item.mainCat === 'global') {
                    prefix = "z_"; 
                    title = " ( 专砖转)";
                } else {
                    prefix = "a_"; 
                    title = item.subCat;
                }
            }

            groupKey = prefix + "###" + title;
            if (!grouped[groupKey]) grouped[groupKey] = [];
            grouped[groupKey].push(item);
        });

        const sortedKeys = Object.keys(grouped).sort();

        sortedKeys.forEach(fullKey => {
            const displayTitle = fullKey.includes("###") ? fullKey.split("###")[1] : fullKey;
            
            const itemsInGroup = grouped[fullKey];
            itemsInGroup.sort((a, b) => (a.purchased ? 1 : 0) - (b.purchased ? 1 : 0));
            const allPurchased = itemsInGroup.length > 0 && itemsInGroup.every(i => i.purchased);
            
            const isCollapsed = collapsedState[displayTitle] || false;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = `sub-group-title ${isCollapsed ? 'closed' : ''} ${allPurchased ? 'completed' : ''}`;
            const checkIcon = allPurchased ? '<i class="fas fa-check-circle" style="margin-left:5px;"></i>' : '';
            
            headerDiv.innerHTML = `<span>${checkIcon}${displayTitle}</span> <i class="fas fa-chevron-down"></i>`;
            headerDiv.onclick = () => toggleGroup(displayTitle);
            
            container.appendChild(headerDiv);

            if (!isCollapsed) {
                itemsInGroup.forEach(item => {
                    const div = document.createElement('div');
                    const isPurchased = item.purchased ? 'is-purchased' : '';
                    div.className = `product-item ${isPurchased}`;
                    
                    const canDelete = isAdmin || item.owner === userId;
                    const deleteHtml = canDelete ? 
                        `<button class="delete-btn" onclick="deleteItem('${item.id}')"><i class="fas fa-trash"></i></button>` : 
                        `<div style="width:40px;"></div>`;

                    const isGlobal = item.mainCat === 'global';
                    const noteHtml = item.note ? `<div class="item-note" id="note-${item.id}">${item.note}</div>` : '';
                    const globalIcon = isGlobal ? '<i class="fas fa-star global-badge"></i>' : '';
                    const noteIndicator = item.note && item.note.trim() !== "" ? 
                        '<i class="fas fa-comment-dots note-indicator"></i>' : '';
                    
                    const purchasedClass = item.purchased ? 'purchased' : '';
                    const clickableClass = isAdmin ? 'clickable' : '';
                    const purchaseAction = isAdmin ? `onclick="togglePurchased('${item.id}', ${item.purchased || false})"` : '';

                    div.innerHTML = `
                        <div class="qty-circle ${purchasedClass} ${clickableClass}" ${purchaseAction}>${item.qty}</div>
                        <div class="item-content" onclick="toggleNote('${item.id}')">
                            <div class="item-name">${globalIcon}${noteIndicator}${item.name}</div>
                            ${noteHtml}
                        </div>
                        ${deleteHtml}
                    `;
                    container.appendChild(div);
                });
            }
        });
    }

    window.toggleQtyBar = function() {
        const bar = document.getElementById('qtyToolbar');
        if (bar.style.display === 'block') {
            bar.style.display = 'none';
        } else {
            bar.innerHTML = '';
            for(let i=1; i<=20; i++) {
                const numDiv = document.createElement('div');
                numDiv.className = 'qty-option';
                numDiv.innerText = i;
                numDiv.onclick = function() { 
                    document.getElementById('itemQty').value = i;
                    bar.style.display = 'none';
                };
                bar.appendChild(numDiv);
            }
            bar.style.display = 'block';
        }
    }

    window.editNote = function() {
        const text = prompt("住 注专 爪专:", currentNote);
        if (text !== null) {
            currentNote = text;
            updateNoteBtnState();
        }
    }

    function updateNoteBtnState() {
        const btn = document.getElementById('noteBtn');
        if (currentNote && currentNote.trim() !== "") {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    }

    window.addItem = function() {
        const name = document.getElementById('itemName').value;
        const qty = document.getElementById('itemQty').value;
        const sub = document.getElementById('subCatSelect').value;
        
        if (!name.trim()) return;
        let mainCat = currentViewKey;
        if (currentViewKey === 'all_view') mainCat = 'global';

        push(ref(db, 'shoppingList'), {
            name: name,
            qty: qty,
            mainCat: mainCat,
            subCat: sub, 
            note: currentNote,
            owner: userId,
            created: Date.now(),
            purchased: false
        });

        document.getElementById('itemName').value = "";
        document.getElementById('itemQty').value = "1";
        currentNote = "";
        updateNoteBtnState();
    }

    window.deleteItem = function(id) {
        if(confirm("拽 转 驻专?")) remove(ref(db, `shoppingList/${id}`));
    }

    window.toggleNote = function(id) {
        const el = document.getElementById(`note-${id}`);
        if(el) el.style.display = el.style.display === 'none' || el.style.display === '' ? 'block' : 'none';
    }

    window.openAdminLogin = function() {
        if(isAdmin) { 
            isAdmin = false;
            alert("转转拽转");
            renderHome();
            return;
        }
        document.getElementById('passwordModal').style.display = 'flex';
    }

    window.checkPass = function() {
        const inp = document.getElementById('adminPass').value;
        if (inp === (appSettings.pass || "1234")) {
            isAdmin = true;
            document.getElementById('passwordModal').style.display = 'none';
            alert("专 ");
            renderHome();
        } else {
            alert("住住 砖");
        }
    }

    window.openSettingsUI = function() {
        const modal = document.getElementById('settingsModal');
        const select = document.getElementById('editorCatSelect');
        select.innerHTML = '<option value="">专...</option>';
        Object.entries(appSettings.categories).forEach(([key, val]) => {
            const op = document.createElement('option');
            op.value = key;
            op.innerText = val.label;
            select.appendChild(op);
        });
        document.getElementById('subsEditorArea').style.display = 'none';
        modal.style.display = 'flex';
    }

    window.renderEditorSubs = function() {
        const key = document.getElementById('editorCatSelect').value;
        const area = document.getElementById('subsEditorArea');
        const tagsDiv = document.getElementById('editorTags');
        if(!key) { area.style.display = 'none'; return; }
        area.style.display = 'block';
        tagsDiv.innerHTML = "";
        const subs = appSettings.categories[key].subs || [];
        subs.forEach(sub => {
            const tag = document.createElement('div');
            tag.className = 'tag-chip';
            tag.innerHTML = `${sub} <i class="fas fa-times-circle" onclick="removeSub('${key}', '${sub}')"></i>`;
            tagsDiv.appendChild(tag);
        });
    }

    window.addNewSub = function() {
        const key = document.getElementById('editorCatSelect').value;
        const input = document.getElementById('newSubInput');
        const newSub = input.value.trim();
        if(!newSub) return;
        const currentSubs = appSettings.categories[key].subs || [];
        if(!currentSubs.includes(newSub)) {
            const updatedSubs = [...currentSubs, newSub];
            update(ref(db, `settings/categories/${key}`), { subs: updatedSubs });
            input.value = "";
            setTimeout(() => { 
                document.getElementById('editorCatSelect').value = key; 
                renderEditorSubs(); 
            }, 300);
        }
    }

    window.removeSub = function(key, subToRemove) {
        if(!confirm(`拽 转 ${subToRemove}?`)) return;
        const currentSubs = appSettings.categories[key].subs || [];
        const updatedSubs = currentSubs.filter(s => s !== subToRemove);
        update(ref(db, `settings/categories/${key}`), { subs: updatedSubs });
        setTimeout(() => { 
             document.getElementById('editorCatSelect').value = key;
             renderEditorSubs(); 
        }, 300);
    }

    window.toggleLock = function() {
        const newLock = !appSettings.locked;
        update(ref(db, 'settings'), { locked: newLock });
        alert(newLock ? "专砖 注" : "专砖 驻转");
        document.getElementById('settingsModal').style.display = 'none';
    }

    window.hardResetCategories = function() {
        if(!confirm("驻注  转拽 拽专转 砖转/驻转 转砖专 专拽 转 5 拽专转 专砖转. 砖?")) return;
        set(ref(db, 'settings/categories'), defaultCats)
        .then(() => {
            alert("拽专转 驻住 爪!");
            document.getElementById('settingsModal').style.display = 'none';
        })
        .catch(err => alert("砖 驻住: " + err));
    }

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>רשימת הקניות שלי</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4a90e2; 
            --accent: #50e3c2;
            --dark: #2C3A47;
            --bg: #f0f2f5;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --danger: #ff6b6b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Rubik', sans-serif;
            background: var(--bg);
            color: var(--dark);
            margin: 0; padding: 0;
            height: 100vh;
            overflow: hidden; /* מונע גלילה של כל הדף */
            display: flex;
            flex-direction: column;
        }

        /* --- מסך בית (גריד קטגוריות) --- */
        #homeView {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .home-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .home-header h1 { margin: 0; color: var(--primary); font-size: 2rem; }
        .home-header p { margin: 5px 0 0; color: #888; }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .cat-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1/1; /* ריבוע */
        }

        .cat-card:active { transform: scale(0.95); }
        .cat-card i { font-size: 2.5rem; margin-bottom: 10px; color: var(--primary); }
        .cat-card h3 { margin: 0; font-size: 1.1rem; }
        
        .cat-card.all-cats {
            background: linear-gradient(135deg, var(--primary), #357abd);
            color: white;
            grid-column: span 2; /* תופס את כל הרוחב */
            aspect-ratio: auto;
            padding: 30px;
        }
        .cat-card.all-cats i { color: white; }

        /* --- מסך קטגוריה פנימי --- */
        #categoryView {
            display: none;
            flex-direction: column;
            height: 100%;
            background: #fff;
        }

        /* חלק עליון קבוע (Sticky) */
        .sticky-section {
            background: var(--glass);
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            z-index: 10;
            border-bottom: 1px solid #eee;
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .back-btn {
            background: #eee; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer;
        }
        .view-title { font-size: 1.4rem; font-weight: 800; color: var(--primary); }

        /* טופס הוספה */
        .add-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-row { display: flex; gap: 10px; }
        
        select, input, textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            background: #f9f9f9;
        }
        
        select { width: 100%; }
        #itemName { flex-grow: 1; }
        #itemQty { width: 70px; text-align: center; }
        
        .add-btn {
            background: var(--accent);
            color: var(--dark);
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(80, 227, 194, 0.3);
        }

        /* --- רשימת המוצרים (נגללת) --- */
        #listScrollArea {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            background: #fcfcfc;
        }

        .sub-group-title {
            font-size: 0.9rem;
            color: #888;
            margin: 20px 0 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .product-item {
            background: white;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            transition: all 0.2s;
            position: relative;
        }

        .qty-circle {
            width: 35px; height: 35px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
            margin-left: 10px;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .item-content {
            flex-grow: 1;
            cursor: pointer;
        }

        .item-name { font-weight: 600; font-size: 1.1rem; }
        .item-note { 
            font-size: 0.85rem; color: #666; background: #f0f0f0; 
            padding: 5px 10px; border-radius: 6px; margin-top: 5px; 
            display: none; /* מוסתר בהתחלה */
        }
        .global-badge { color: gold; font-size: 0.8rem; margin-right: 5px; }

        .delete-btn {
            background: #ffecec; color: var(--danger);
            border: none; width: 30px; height: 30px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            margin-right: 10px; cursor: pointer;
        }

        /* --- אדמין וכפתורים צפים --- */
        .admin-float {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255,255,255,0.8); padding: 5px 10px;
            border-radius: 20px; font-size: 0.8rem; border: none;
            backdrop-filter: blur(5px);
        }

        /* מודאלים */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; }
        .close-modal { float: right; font-size: 1.5rem; cursor: pointer; }
    </style>
</head>
<body>

<div id="homeView">
    <button class="admin-float" onclick="openAdminLogin()"><i class="fas fa-user-shield"></i> מנהל</button>
    
    <div class="home-header">
        <h1>הקניות שלנו</h1>
        <p>בחר קטגוריה כדי להתחיל</p>
    </div>

    <div class="grid-container" id="categoryGrid">
        </div>
</div>

<div id="categoryView">
    <div class="sticky-section">
        <div class="view-header">
            <button class="back-btn" onclick="backToHome()"><i class="fas fa-arrow-right"></i> חזרה</button>
            <div class="view-title" id="viewTitle">שם הקטגוריה</div>
            <div style="width: 60px;"></div> </div>

        <div class="add-form" id="addForm">
            <select id="subCatSelect"></select>
            
            <div class="input-row">
                <input type="text" id="itemName" placeholder="שם מוצר...">
                <input type="number" id="itemQty" placeholder="כמות" value="1" min="1">
            </div>
            
            <textarea id="itemNote" rows="1" placeholder="הערה (אופציונלי)" style="resize: none;"></textarea>
            
            <button class="add-btn" onclick="addItem()">הוסף לרשימה <i class="fas fa-plus"></i></button>
        </div>
        <div id="lockedMsg" style="display:none; color:red; text-align:center; margin-top:5px;">הרשימה נעולה</div>
    </div>

    <div id="listScrollArea">
        </div>
</div>

<div id="passwordModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('passwordModal')">&times;</span>
        <h3>כניסת מנהל</h3>
        <input type="password" id="adminPass" placeholder="סיסמה" style="width:100%; margin:15px 0;">
        <button class="add-btn" onclick="checkPass()">כניסה</button>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content" style="max-width:500px;">
        <span class="close-modal" onclick="closeModal('settingsModal')">&times;</span>
        <h3>עריכת קטגוריות (JSON)</h3>
        <p style="font-size:0.8rem; color:#666;">יש להיזהר בעריכה. זה המבנה של האתר.</p>
        <textarea id="jsonEditor" style="width:100%; height:200px; direction:ltr; font-family:monospace;"></textarea>
        <br><br>
        <button class="add-btn" onclick="saveSettings()">שמור שינויים</button>
        <button class="add-btn" onclick="toggleLock()" style="background:#ff6b6b; margin-top:10px;">נעל/פתח הוספה</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- הגדרות ה-FIREBASE שלך ---
    // העתק לכאן את הנתונים שלך
    const firebaseConfig = {
        apiKey: "AIzaSyAoXUKwnQpcxyZdYCT9PUh-yjmOj6kugTQ",
        authDomain: "family-shopping-891f7.firebaseapp.com",
        databaseURL: "https://family-shopping-891f7-default-rtdb.firebaseio.com",
        projectId: "family-shopping-891f7",
        storageBucket: "family-shopping-891f7.firebasestorage.app",
        messagingSenderId: "16936955736",
        appId: "1:16936955736:web:dca42916750112b7787f2d",
        measurementId: "G-QPL3C428RN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // זיהוי משתמש
    let userId = localStorage.getItem('shop_uid') || 'user_' + Math.random().toString(36).substr(2, 5);
    localStorage.setItem('shop_uid', userId);

    // משתנים גלובליים
    let isAdmin = false;
    let currentViewKey = null; // הקטגוריה שבה אנחנו צופים כרגע
    let allData = {};
    let appSettings = {};

    // ברירת מחדל לקטגוריות לפי בקשתך
    const defaultCats = {
        osher_ad: { 
            label: "אושר עד", icon: "fa-cart-shopping", 
            subs: ["פירות וירקות", "קפואים", "סלטים", "מוצרי חלב", "מצרכים", "חד פעמי", "ניקיון", "אחר"] 
        },
        max_stock: { 
            label: "מקס סטוק", icon: "fa-box-open", 
            subs: ["אחר"] 
        },
        tambour: { 
            label: "טמבור", icon: "fa-tools", 
            subs: ["חשמל", "כלי עבודה", "פרזול", "חומרי מליטה", "אחר"] 
        },
        pickups: { 
            label: "איסוף משלוחים", icon: "fa-envelope", 
            subs: ["קניות ישראל תלפיות", "בשכונה", "גילה", "מלחה", "אחר"] 
        },
        other: { 
            label: "אחר", icon: "fa-star", 
            subs: ["כללי"] 
        }
    };

    // --- טעינת נתונים ---
    const settingsRef = ref(db, 'settings');
    onValue(settingsRef, (snap) => {
        const val = snap.val();
        if (!val) {
            set(settingsRef, { categories: defaultCats, locked: false, pass: "1234" });
            return;
        }
        appSettings = val;
        renderHome();
        if (currentViewKey) renderList(); // רענון אם אנחנו בתוך קטגוריה
    });

    onValue(ref(db, 'shoppingList'), (snap) => {
        allData = snap.val() || {};
        if (currentViewKey) renderList();
    });

    // --- ניווט ורינדור ---

    function renderHome() {
        const grid = document.getElementById('categoryGrid');
        grid.innerHTML = "";

        // כפתור "כל הקטגוריות"
        const allBtn = document.createElement('div');
        allBtn.className = 'cat-card all-cats';
        allBtn.innerHTML = `<i class="fas fa-layer-group"></i><h3>כל הקטגוריות</h3>`;
        allBtn.onclick = () => openCategory('all_view');
        grid.appendChild(allBtn);

        // שאר הקטגוריות
        const cats = appSettings.categories || defaultCats;
        Object.entries(cats).forEach(([key, data]) => {
            const card = document.createElement('div');
            card.className = 'cat-card';
            card.innerHTML = `<i class="fas ${data.icon || 'fa-circle'}"></i><h3>${data.label}</h3>`;
            card.onclick = () => openCategory(key);
            grid.appendChild(card);
        });

        // כפתור עריכה למנהל
        if(isAdmin) {
            const editBtn = document.createElement('div');
            editBtn.className = 'cat-card';
            editBtn.style.background = '#eee';
            editBtn.innerHTML = '<i class="fas fa-cog"></i><h3>הגדרות</h3>';
            editBtn.onclick = () => {
                document.getElementById('jsonEditor').value = JSON.stringify(appSettings.categories, null, 2);
                document.getElementById('settingsModal').style.display = 'flex';
            };
            grid.appendChild(editBtn);
        }
    }

    window.openCategory = function(key) {
        currentViewKey = key;
        document.getElementById('homeView').style.display = 'none';
        document.getElementById('categoryView').style.display = 'flex';
        
        const isAll = key === 'all_view';
        const cats = appSettings.categories || defaultCats;
        const currentCat = cats[key];

        // כותרת
        document.getElementById('viewTitle').innerText = isAll ? "כל הקטגוריות" : currentCat.label;

        // סלקט תתי קטגוריות
        const subSelect = document.getElementById('subCatSelect');
        subSelect.innerHTML = "";
        
        if (isAll) {
            // ב"כל הקטגוריות", הוספה היא גלובלית
            // למרות שהמשתמש ביקש "הוסף מוצרים שיופיעו בכל הרשימות", נחבר אותם לקטגוריה "כללי" או מיוחדת
            // נשתמש בקטגוריה הראשית כמזהה
            const opt = document.createElement('option');
            opt.value = "global";
            opt.innerText = "מוצר שמופיע בכל הרשימות";
            subSelect.appendChild(opt);
            
            // אפשר להוסיף כאן לוגיקה שתאפשר לבחור לאיזו קטגוריה להוסיף, אבל הפשטות עדיפה
        } else {
            currentCat.subs.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.innerText = sub;
                subSelect.appendChild(opt);
            });
        }
        
        // נעילה
        const locked = appSettings.locked && !isAdmin;
        document.getElementById('addForm').style.display = locked ? 'none' : 'flex';
        document.getElementById('lockedMsg').style.display = locked ? 'block' : 'none';

        renderList();
    }

    window.backToHome = function() {
        currentViewKey = null;
        document.getElementById('categoryView').style.display = 'none';
        document.getElementById('homeView').style.display = 'flex';
    }

    function renderList() {
        const container = document.getElementById('listScrollArea');
        container.innerHTML = "";
        
        const items = Object.entries(allData).map(([id, val]) => ({ id, ...val }));
        const isAllView = currentViewKey === 'all_view';

        // סינון: מה מציגים?
        // אם אנחנו ב"כל הקטגוריות": מציגים הכל.
        // אם אנחנו בקטגוריה ספציפית: מציגים מוצרים שלה + מוצרים גלובליים.
        const filteredItems = items.filter(item => {
            if (isAllView) return true;
            return item.mainCat === currentViewKey || item.mainCat === 'global';
        });

        if (filteredItems.length === 0) {
            container.innerHTML = '<div style="text-align:center; margin-top:30px; color:#aaa;">אין מוצרים ברשימה</div>';
            return;
        }

        // קיבוץ (Grouping)
        // אם אנחנו ב"הכל" - נקבץ לפי קטגוריה ראשית
        // אם אנחנו בקטגוריה - נקבץ לפי תת-קטגוריה
        const grouped = {};
        const cats = appSettings.categories || defaultCats;

        filteredItems.forEach(item => {
            let groupKey;
            
            if (isAllView) {
                // תצוגת הכל: כותרת היא הקטגוריה הראשית
                if (item.mainCat === 'global') groupKey = "מוצרים בכל הרשימות";
                else groupKey = cats[item.mainCat] ? cats[item.mainCat].label : "אחר";
            } else {
                // תצוגה רגילה: כותרת היא תת הקטגוריה
                if (item.mainCat === 'global') groupKey = "כללי (מופיע בכל הרשימות)";
                else groupKey = item.subCat;
            }

            if (!grouped[groupKey]) grouped[groupKey] = [];
            grouped[groupKey].push(item);
        });

        // יצירת ה-HTML
        Object.keys(grouped).forEach(groupTitle => {
            const header = document.createElement('div');
            header.className = 'sub-group-title';
            header.innerText = groupTitle;
            container.appendChild(header);

            grouped[groupTitle].forEach(item => {
                const div = document.createElement('div');
                div.className = 'product-item';
                
                // כפתור מחיקה
                const canDelete = isAdmin || item.owner === userId;
                // מחיקה של מוצר גלובלי תמחק מכולם כי הוא פשוט אובייקט אחד בבסיס הנתונים
                
                const deleteHtml = canDelete ? 
                    `<button class="delete-btn" onclick="deleteItem('${item.id}')"><i class="fas fa-trash"></i></button>` : 
                    `<div style="width:40px;"></div>`;

                const isGlobal = item.mainCat === 'global';
                const noteHtml = item.note ? `<div class="item-note" id="note-${item.id}">${item.note}</div>` : '';
                const globalIcon = isGlobal ? '<i class="fas fa-star global-badge"></i>' : '';

                div.innerHTML = `
                    ${deleteHtml}
                    <div class="item-content" onclick="toggleNote('${item.id}')">
                        <div class="item-name">${globalIcon}${item.name}</div>
                        ${noteHtml}
                    </div>
                    <div class="qty-circle">${item.qty}</div>
                `;
                container.appendChild(div);
            });
        });
    }

    // --- פעולות ---

    window.addItem = function() {
        const name = document.getElementById('itemName').value;
        const qty = document.getElementById('itemQty').value;
        const sub = document.getElementById('subCatSelect').value;
        const note = document.getElementById('itemNote').value;

        if (!name.trim()) return;

        // אם אנחנו ב"כל הקטגוריות", הקטגוריה הראשית היא 'global'
        const mainCat = currentViewKey === 'all_view' ? 'global' : currentViewKey;

        push(ref(db, 'shoppingList'), {
            name: name,
            qty: qty,
            mainCat: mainCat,
            subCat: sub, // במקרה של גלובל זה יהיה "global"
            note: note,
            owner: userId,
            created: Date.now()
        });

        // ניקוי
        document.getElementById('itemName').value = "";
        document.getElementById('itemNote').value = "";
        document.getElementById('itemQty').value = "1";
    }

    window.deleteItem = function(id) {
        if(confirm("למחוק?")) {
            remove(ref(db, `shoppingList/${id}`));
        }
    }

    window.toggleNote = function(id) {
        const el = document.getElementById(`note-${id}`);
        if(el) {
            el.style.display = el.style.display === 'none' || el.style.display === '' ? 'block' : 'none';
        }
    }

    // --- אדמין ---

    window.openAdminLogin = function() {
        if(isAdmin) { // אם כבר מחובר, התנתק
            isAdmin = false;
            alert("התנתקת");
            renderHome();
            if(currentViewKey) renderList(); // עדכון מצב נעילה
            return;
        }
        document.getElementById('passwordModal').style.display = 'flex';
    }

    window.checkPass = function() {
        const inp = document.getElementById('adminPass').value;
        if (inp === (appSettings.pass || "1234")) {
            isAdmin = true;
            document.getElementById('passwordModal').style.display = 'none';
            alert("מחובר כמנהל");
            renderHome(); // יציג כפתור הגדרות
            if(currentViewKey) {
                 openCategory(currentViewKey); // רענון נעילות
            }
        } else {
            alert("סיסמה שגויה");
        }
    }

    window.saveSettings = function() {
        try {
            const newCats = JSON.parse(document.getElementById('jsonEditor').value);
            update(ref(db, 'settings'), { categories: newCats });
            document.getElementById('settingsModal').style.display = 'none';
        } catch(e) { alert("שגיאה בקוד JSON"); }
    }

    window.toggleLock = function() {
        const newLock = !appSettings.locked;
        update(ref(db, 'settings'), { locked: newLock });
        alert(newLock ? "רשימה ננעלה" : "רשימה נפתחה");
    }

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
</script>

</body>
</html>
